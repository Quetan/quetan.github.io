<!--
    ****************************
         1. HTML-разметка календаря
    ****************************
-->

<section
	class="announces-section calendar-section"
	style="background: none; background-color: #004b74"
>
	<div
		class="
			announces-section_header
			d-flex
			justify-content-center
			align-items-center
		"
	>
		<h2 class="section-header">Календарь событий</h2>
	</div>

	<div class="announces-triangles d-none d-md-block">
		<img class="triangle1" src="./img/main/advantages/triangle1.svg" alt="" />
		<img class="triangle2" src="./img/main/advantages/triangle2.svg" alt="" />
		<img class="triangle3" src="./img/main/advantages/triangle3.svg" alt="" />
	</div>

	<div class="announces-section_content" style="background-image: none">
		<div class="container announces-container">
			<div class="row calendars">
				<div class="d-none d-lg-block col-lg-4 calendar-item">
					<div class="calendar-container">
						<table class="calendar-table" id="calendar2">
							<thead>
								<tr>
									<td></td>
									<td class="calendar-month" colspan="5"></td>
									<td></td>
								</tr>
								<tr class="calendar-days-row">
									<td>Пн</td>
									<td>Вт</td>
									<td>Ср</td>
									<td>Чт</td>
									<td>Пт</td>
									<td>Сб</td>
									<td>Вс</td>
								</tr>
							</thead>

							<tbody></tbody>
						</table>
					</div>
				</div>
				<div class="col-12 col-md-6 col-lg-4 calendar-item">
					<div class="calendar-container">
						<table class="calendar-table" id="calendar3">
							<thead>
								<tr>
									<td></td>
									<td class="calendar-month" colspan="5"></td>
									<td></td>
								</tr>
								<tr class="calendar-days-row">
									<td>Пн</td>
									<td>Вт</td>
									<td>Ср</td>
									<td>Чт</td>
									<td>Пт</td>
									<td>Сб</td>
									<td>Вс</td>
								</tr>
							</thead>

							<tbody></tbody>
						</table>
					</div>
				</div>
				<div class="d-none d-md-block col-md-6 col-lg-4 calendar-item">
					<div class="calendar-container">
						<table class="calendar-table" id="calendar4">
							<thead>
								<tr>
									<td></td>
									<td class="calendar-month" colspan="5"></td>
									<td></td>
								</tr>
								<tr class="calendar-days-row">
									<td>Пн</td>
									<td>Вт</td>
									<td>Ср</td>
									<td>Чт</td>
									<td>Пт</td>
									<td>Сб</td>
									<td>Вс</td>
								</tr>
							</thead>

							<tbody></tbody>
						</table>
					</div>
				</div>
			</div>
		</div>
	</div>
</section>

<!--
    ****************************
         2. СКРИПТЫ для функционирования
         и заполнения календаря

         
         ** У каждой даты есть id вида YYYYMMDD, 
         ** где YYYY - год, MM - месяц, DD - день.
         ** CSS Классы:
         ** 1.today - сегодняшная дата
         ** 2.event - дата, когда есть событие

    ****************************
-->

<script>
	function Calendar2(id, year, month) {
		var Dlast = new Date(year, month + 1, 0).getDate(),
			D = new Date(year, month, Dlast),
			DNlast = new Date(D.getFullYear(), D.getMonth(), Dlast).getDay(),
			DNfirst = new Date(D.getFullYear(), D.getMonth(), 1).getDay(),
			calendar = '<tr>',
			month = [
				'Январь',
				'Февраль',
				'Март',
				'Апрель',
				'Май',
				'Июнь',
				'Июль',
				'Август',
				'Сентябрь',
				'Октябрь',
				'Ноябрь',
				'Декабрь',
			];
		let offset = 0;
		if (DNfirst != 0) {
			for (var i = 1; i < DNfirst; i++) {
				calendar += '<td>';
				offset += 1;
			}
		} else {
			for (var i = 0; i < 6; i++) calendar += 'td';
		}
		let rightsided = [];
		for (var i = 1; i <= Dlast; i++) {
			//Создаем массив с числами, которые находятся справа,
			//чтобы избежать заплыва всплывающего окна за экран
			for (var j = 1; j < 6; j++) {
				if (
					i === 7 * j - offset ||
					i === 7 * j - offset - 1 ||
					i === 7 * j - offset - 2
				) {
					rightsided.push(i);
				}
			}
			//Если дата совпадает с сегодняшней, то даем класс today
			if (
				i == new Date().getDate() &&
				D.getFullYear() == new Date().getFullYear() &&
				D.getMonth() == new Date().getMonth()
			) {
				calendar +=
					'<td class="today js_date" id="date' +
					String(D.getFullYear()) +
					(String(D.getMonth() + 1) < 10
						? String('0' + (D.getMonth() + 1))
						: String(D.getMonth() + 1)) +
					(i < 10 ? String('0' + i) : String(i)) +
					'">' +
					i;
			} else {
				//Проверяем, попадает ли дата в правосторонние
				if (rightsided.includes(i)) {
					calendar +=
						'<td class="js_date rightsided" id="date' +
						String(D.getFullYear()) +
						(String(D.getMonth() + 1) < 10
							? String('0' + (D.getMonth() + 1))
							: String(D.getMonth() + 1)) +
						(i < 10 ? String('0' + i) : String(i)) +
						'">' +
						i;
				} else {
					calendar +=
						'<td class="js_date" id="date' +
						String(D.getFullYear()) +
						(String(D.getMonth() + 1) < 10
							? String('0' + (D.getMonth() + 1))
							: String(D.getMonth() + 1)) +
						(i < 10 ? String('0' + i) : String(i)) +
						'">' +
						i;
				}
			}
			if (new Date(D.getFullYear(), D.getMonth(), i).getDay() == 0) {
				calendar += '<tr>';
			}
		}
		for (var i = DNlast; i < 7; i++) calendar += '<td>&nbsp;';
		document.querySelector('#' + id + ' tbody').innerHTML = calendar;
		document.querySelector('#' + id + ' thead td:nth-child(2)').innerHTML =
			month[D.getMonth()] + ' ' + D.getFullYear();
		document.querySelector('#' + id + ' thead td:nth-child(2)').dataset.month =
			D.getMonth();
		document.querySelector('#' + id + ' thead td:nth-child(2)').dataset.year =
			D.getFullYear();
		if (document.querySelectorAll('#' + id + ' tbody tr').length < 6) {
			document.querySelector('#' + id + ' tbody').innerHTML +=
				'<tr><td>&nbsp;<td>&nbsp;<td>&nbsp;<td>&nbsp;<td>&nbsp;<td>&nbsp;<td>&nbsp;';
		}
	}

	Calendar2('calendar2', new Date().getFullYear(), new Date().getMonth() - 1);
	Calendar2('calendar3', new Date().getFullYear(), new Date().getMonth());
	Calendar2('calendar4', new Date().getFullYear(), new Date().getMonth() + 1);

	//Пример массива с событиями
	let events = [
		{
			id: 0,
			date: '20211001',
			events: [
				{ title: 'Title of event1', url: '/news/42680' },
				{ title: 'Title of event2', url: '/news/42660' },
			],
		},
		{
			id: 1,
			date: '20211027',
			events: [
				{ title: 'Title of event3', url: '/news/42680' },
				{ title: 'Title of event4', url: '/news/42660' },
			],
		},
		{
			id: 2,
			date: '20211118',
			events: [
				{ title: 'Title of event5', url: '/news/42680' },
				{ title: 'Title of event61', url: '/news/42660' },
				{ title: 'Title of event62', url: '/news/42660' },
				{
					title:
						'Title, of event63 Title, of event63Title, of event63Title, of event63',
					url: '/news/42660',
				},
				{ title: 'Title of event64', url: '/news/42660' },
			],
		},
		{
			id: 3,
			date: '20211207',
			events: [
				{ title: 'Title of event7', url: '/news/42680' },
				{ title: 'Title of event8', url: '/news/42660' },
			],
		},
		{
			id: 4,
			date: '20211226',
			events: [
				{
					title: 'Title of event7',
					url: '/news/42680',
				},
				{ title: 'Title of event8', url: '/news/42660' },
			],
		},
	];

	if (events) {
		events.forEach((e) => {
			let item = document.querySelector(String('#date' + e.date));
			if (item) {
				item.classList.add('event');
				item.setAttribute('date', e.date);
				//Popup
				let popup = document.createElement('div');
				popup.id = 'popup' + e.date;
				popup.classList.add('events-popup');
				//Popup header
				let header = document.createElement('span');
				header.classList.add('popup-header');
				header.innerHTML = 'События дня';
				popup.appendChild(header);
				//List
				let list = document.createElement('ul');
				list.classList.add('popup-list');
				popup.appendChild(list);
				//List items
				e.events.forEach((i) => {
					let event = document.createElement('li');
					event.classList.add('popup-event');
					//Link
					let url = document.createElement('a');
					url.href = i.url;
					url.text = String(i.title);
					event.appendChild(url);
					list.appendChild(event);
				});
				item.appendChild(popup);
			}
		});
	}

	(function () {
		let dates_arr = document.querySelectorAll('.js_date');
		dates_arr.forEach((date) => {
			date.addEventListener('click', (e) => {
				window.location.href =
					'/news/?date=' + String(date.id.split('date')[1]);
			});
		});
	})();

	(function () {
		let dates_arr = document.querySelectorAll('.js_date');
		dates_arr.forEach((date) => {
			let popup = document.querySelector(
				'#popup' + String(date.id.split('date')[1])
			);
			if (popup) {
				date.addEventListener('mouseenter', (e) => {
					popup.style.display = 'block';
				});
				date.addEventListener('mouseleave', (e) => {
					popup.style.display = 'none';
				});
			}
		});
	})();
</script>
